-- Load Shaman UI Library
local Library = loadstring(game:HttpGet('https://raw.githubusercontent.com/Rain-Design/Libraries/main/Shaman/Library.lua'))()
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Lighting = game:GetService("Lighting")
local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")
local TweenService = game:GetService("TweenService")

local LocalPlayer = Players.LocalPlayer
local Flags = Library.Flags

-- UI Setup
local Window = Library:Window({ Text = "The Rake: Remastered" })
local MainTab = Window:Tab({ Text = "Main" })
local VisualTab = Window:Tab({ Text = "Visual" })
local StatusTab = Window:Tab({ Text = "Status" })
local PlayerTab = Window:Tab({ Text = "Player" })

-- Sections
local Gameplay = MainTab:Section({ Text = "Gameplay" })
local Morphs = MainTab:Section({ Text = "Morphs" })
local Teleport = MainTab:Section({ Text = "Teleport" })
local ESP = VisualTab:Section({ Text = "ESP" })
local Status = StatusTab:Section({ Text = "Live Info" })

-- Status Labels
local FlareLabel = Status:Label({ Text = "Flare Gun: Unknown" })
local RakeLabel = Status:Label({ Text = "Rake: Unknown" })
local BloodHourLabel = Status:Label({ Text = "Blood Hour: Unknown" })

-- Status Updater (real-time)
RunService.RenderStepped:Connect(function()
    local flare = Workspace:FindFirstChild("FlareGun") or Workspace:FindFirstChildWhichIsA("Tool", true)
    FlareLabel:Set({ Text = flare and "Flare Gun: Spawned" or "Flare Gun: Not Found" })

    local rake = Workspace:FindFirstChild("Rake") or Workspace:FindFirstChild("RakeAI")
    RakeLabel:Set({ Text = rake and "Rake: Active" or "Rake: Not Spawned" })

    local bh = ReplicatedStorage:FindFirstChild("BloodHour")
    BloodHourLabel:Set({ Text = bh and bh.Value and "Blood Hour: ACTIVE" or "Blood Hour: Inactive" })
end)

-- WalkSpeed Bypass toggle
local walkSpeedConnection
Gameplay:Toggle({
    Text = "WalkSpeed Bypass (30)",
    Callback = function(state)
        if walkSpeedConnection then walkSpeedConnection:Disconnect() end
        if state then
            walkSpeedConnection = RunService.RenderStepped:Connect(function()
                local hum = LocalPlayer.Character and LocalPlayer.Character:FindFirstChildOfClass("Humanoid")
                if hum and hum.WalkSpeed ~= 30 then hum.WalkSpeed = 30 end
            end)
        end
    end
})

-- Infinite Stamina toggle with full regen logic
Gameplay:Toggle({
    Text = "Infinite Stamina",
    Callback = function(state)
        RunService:UnbindFromRenderStep("Stamina")
        if state then
            RunService:BindToRenderStep("Stamina", 100, function()
                local energy = LocalPlayer:FindFirstChild("Energy")
                if energy then energy.Value = 100 end

                for i,v in pairs(getgc and getgc(true) or {}) do
                    if type(v) == "table" and rawget(v,"STAMINA_REGEN") then
                        v.STAMINA_REGEN = 100
                        v.JUMP_STAMINA = 0
                        v.JUMP_COOLDOWN = 0
                        v.STAMINA_TAKE = 0
                        v.stamina = 100
                    end
                end
            end)
        end
    end
})

-- Full Bright toggle
Gameplay:Toggle({
    Text = "Full Bright",
    Callback = function(state)
        local function dofullbright()
            if state then
                Lighting.Ambient = Color3.new(1, 1, 1)
                Lighting.ColorShift_Bottom = Color3.new(1, 1, 1)
                Lighting.ColorShift_Top = Color3.new(1, 1, 1)
                Lighting.Brightness = 3
                Lighting.FogEnd = 100000
            else
                Lighting.Ambient = Color3.new(0, 0, 0)
                Lighting.ColorShift_Bottom = Color3.new(0, 0, 0)
                Lighting.ColorShift_Top = Color3.new(0, 0, 0)
                Lighting.Brightness = 1
                Lighting.FogEnd = 1000
            end
        end

        dofullbright()
        if Flags.FullBrightConnection then Flags.FullBrightConnection:Disconnect() Flags.FullBrightConnection = nil end

        if state then
            Flags.FullBrightConnection = Lighting.LightingChanged:Connect(dofullbright)
        end
    end
})

-- No Fall Damage hook (metatable hook)
_G.NoFallDMG = false
do
    local mt = getrawmetatable(game)
    local oldNamecall = mt.__namecall
    setreadonly(mt, false)

    mt.__namecall = newcclosure(function(self, ...)
        local method = getnamecallmethod()
        local args = {...}

        if _G.NoFallDMG and tostring(self) == "FD_Event" and method == "FireServer" then
            args[1] = 0
            args[2] = 0
            return self.FireServer(self, unpack(args))
        end

        return oldNamecall(self, ...)
    end)

    setreadonly(mt, true)
end

Gameplay:Toggle({
    Text = "No Fall Damage",
    Callback = function(state)
        _G.NoFallDMG = state
    end,
})

-- God Mode (Infinite Health Regen)
local godModeConnection
Gameplay:Toggle({
    Text = "God Mode (Infinite Regen)",
    Callback = function(state)
        if godModeConnection then godModeConnection:Disconnect() godModeConnection = nil end
        if state then
            godModeConnection = RunService.Heartbeat:Connect(function(deltaTime)
                local char = LocalPlayer.Character
                if char then
                    local hum = char:FindFirstChildWhichIsA("Humanoid")
                    if hum and hum.Health < hum.MaxHealth then
                        hum.Health = math.min(hum.Health + (50 * deltaTime), hum.MaxHealth)
                    end
                end
            end)
        end
    end
})

-- Morphing function
local function MorphInto(name)
    local morph = ReplicatedStorage:FindFirstChild("Morphs") and ReplicatedStorage.Morphs:FindFirstChild(name)
    if morph then ReplicatedStorage:WaitForChild("CharChange"):FireServer(morph) end
end

Morphs:Button({ Text = "Blood Rake", Callback = function() MorphInto("BloodRakeMorph") end })
Morphs:Button({ Text = "Rage Rake", Callback = function() MorphInto("RageRakeMorph") end })
Morphs:Button({ Text = "Shadow Rake", Callback = function() MorphInto("ShadowHourRake") end })
Morphs:Button({ Text = "Vision Rake", Callback = function() MorphInto("VisionRakeMorph") end })
Morphs:Button({ Text = "Corrupted Rake", Callback = function() MorphInto("CorrupteredRakeMorph") end })

-- Teleport to Flare Gun (Manual only)
Teleport:Button({
    Text = "Teleport to Flare Gun",
    Callback = function()
        for _, obj in pairs(Workspace:GetDescendants()) do
            if obj:IsA("Tool") and obj.Name:lower():find("flare") then
                if LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then
                    LocalPlayer.Character.HumanoidRootPart.CFrame = obj.Handle.CFrame + Vector3.new(0, 3, 0)
                end
                break
            end
        end
    end
})

-- ESP Helpers
local activeESP = {}

local function applyHighlight(obj, color)
    if not obj or not obj:IsDescendantOf(Workspace) then return end
    if not activeESP[obj] and obj:FindFirstChild("HumanoidRootPart") then
        local h = Instance.new("Highlight", obj)
        h.FillColor = color
        h.OutlineColor = color
        h.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
        activeESP[obj] = h
    end
end

local function clearESP()
    for obj, h in pairs(activeESP) do
        if h then h:Destroy() end
    end
    activeESP = {}
end

-- ESP toggles
ESP:Toggle({
    Text = "ESP: Rake",
    Callback = function(state)
        RunService:UnbindFromRenderStep("RakeESP")
        if state then
            RunService:BindToRenderStep("RakeESP", 1, function()
                for _, v in pairs(Workspace:GetChildren()) do
                    if v.Name:lower():find("rake") then
                        applyHighlight(v, Color3.fromRGB(255, 0, 0))
                    end
                end
            end)
        else
            clearESP()
        end
    end
})

ESP:Toggle({
    Text = "ESP: Players",
    Callback = function(state)
        RunService:UnbindFromRenderStep("PlayerESP")
        if state then
            RunService:BindToRenderStep("PlayerESP", 1, function()
                for _, p in pairs(Players:GetPlayers()) do
                    if p ~= LocalPlayer and p.Character then
                        applyHighlight(p.Character, Color3.fromRGB(0, 170, 255))
                    end
                end
            end)
        else
            clearESP()
        end
    end
})

-- Pass Noclip Chair function
local noclipConnection
Gameplay:Toggle({
    Text = "Pass Noclip Chair",
    Callback = function(state)
        if noclipConnection then noclipConnection:Disconnect() noclipConnection = nil end
        if state then
            noclipConnection = RunService.Stepped:Connect(function()
                local char = LocalPlayer.Character
                if char then
                    for _, part in pairs(char:GetChildren()) do
                        if part:IsA("BasePart") then
                            part.CanCollide = false
                        end
                    end
                end
            end)
        else
            local char = LocalPlayer.Character
            if char then
                for _, part in pairs(char:GetChildren()) do
                    if part:IsA("BasePart") then
                        part.CanCollide = true
                    end
                end
            end
        end
    end
})
